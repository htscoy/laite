import{isRedirect as F,isNotFound as x}from"@tanstack/router-core";import E from"tiny-invariant";import{eventHandler as N,toWebRequest as b,getResponseStatus as j,getEvent as I}from"@tanstack/start-server-core";import{createMiddleware as C,registerGlobalMiddleware as L,startSerializer as u}from"@tanstack/start-client-core";const O={"src_actions_addDeviceFn_ts--addDevice_createServerFn_handler":{functionName:"addDevice_createServerFn_handler",importer:()=>import("./assets/addDeviceFn-Dg_syz81.js")}},A=C().client(async e=>{const t=new Date;return e.next({context:{clientTime:t},sendContext:{clientTime:t}})}).server(async e=>{const t=new Date;return e.next({sendContext:{serverTime:t,durationToServer:t.getTime()-e.context.clientTime.getTime()}})}),J=C().middleware([A]).client(async e=>{const t=await e.next(),r=new Date;return console.log("Client Req/Res:",{duration:t.context.clientTime.getTime()-r.getTime(),durationToServer:t.context.durationToServer,durationFromServer:r.getTime()-t.context.serverTime.getTime()}),t});L({middleware:[J]});const U=N($),p=O;async function $(e){const t=b(e);return await z({request:t,event:e})}function q(e){return e.replace(/^\/|\/$/g,"")}async function z({request:e,event:t}){const r=new AbortController,i=r.signal,v=()=>r.abort();t.node.req.on("close",v);const g=e.method,h=new URL(e.url,"http://localhost:3000"),M=new RegExp(`${q("/_server")}/([^/?#]+)`),y=h.pathname.match(M),s=y?y[1]:null,c=Object.fromEntries(h.searchParams.entries()),m="createServerFn"in c,D="raw"in c;if(typeof s!="string")throw new Error("Invalid server action param for serverFnId: "+s);const w=p[s];if(!w)throw console.log("serverFnManifest",p),new Error("Server function info not found for "+s);let l;if(l=await w.importer(),!l)throw console.log("serverFnManifest",p),new Error("Server function module not resolved for "+s);const a=l[w.functionName];if(!a)throw console.log("serverFnManifest",p),console.log("fnModule",l),new Error(`Server function module export not resolved for serverFn ID: ${s}`);const _=["multipart/form-data","application/x-www-form-urlencoded"],d=await(async()=>{try{let n=await(async()=>{if(e.headers.get("Content-Type")&&_.some(o=>{var S;return(S=e.headers.get("Content-Type"))==null?void 0:S.includes(o)}))return E(g.toLowerCase()!=="get","GET requests with FormData payloads are not supported"),await a(await e.formData(),i);if(g.toLowerCase()==="get"){let o=c;return m&&(o=c.payload),o=o&&u.parse(o),await a(o,i)}const f=await e.text(),T=u.parse(f);return m?await a(T,i):await a(...T,i)})();return n.result instanceof Response?n.result:!m&&(n=n.result,n instanceof Response)?n:F(n)||x(n)?R(n):new Response(n!==void 0?u.stringify(n):void 0,{status:j(I()),headers:{"Content-Type":"application/json"}})}catch(n){return n instanceof Response?n:F(n)||x(n)?R(n):(console.info(),console.info("Server Fn Error!"),console.info(),console.error(n),console.info(),new Response(u.stringify(n),{status:500,headers:{"Content-Type":"application/json"}}))}})();if(t.node.req.removeListener("close",v),D)return d;if(d.headers.get("Content-Type")==="application/json"){const f=await d.clone().text();f&&JSON.stringify(JSON.parse(f))}return d}function R(e){const{headers:t,...r}=e;return new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json",...t||{}}})}export{U as default};
